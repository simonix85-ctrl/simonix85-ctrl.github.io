<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>UnderCover</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Orbitron', 'sans-serif'] },
            colors: {
              neon: { blue: '#00f3ff', pink: '#ff00ff', purple: '#bc13fe', green: '#0aff00' },
              dark: { bg: '#0f172a', card: '#1e293b' }
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'float': 'float 6s ease-in-out infinite',
              'fadeIn': 'fadeIn 0.5s ease-out',
            },
            keyframes: {
              float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } },
              fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
            }
          }
        }
      }
    </script>
    <style>
      :root {
        --bg-color: #0f172a; --text-main: #ffffff; --text-muted: #94a3b8;
        --panel-bg: rgba(30, 41, 59, 0.7); --panel-border: rgba(255, 255, 255, 0.1);
        --input-bg: rgba(0, 0, 0, 0.4); --item-bg: rgba(255, 255, 255, 0.05);
        --item-hover: rgba(255, 255, 255, 0.1); --card-back: rgba(30, 41, 59, 0.8);
      }
      body.light-mode {
        --bg-color: #f0f9ff; --text-main: #1e293b; --text-muted: #64748b;
        --panel-bg: rgba(255, 255, 255, 0.75); --panel-border: rgba(0, 0, 0, 0.1);
        --input-bg: #ffffff; --item-bg: rgba(0, 0, 0, 0.05);
        --item-hover: rgba(0, 0, 0, 0.08); --card-back: rgba(255, 255, 255, 0.9);
      }
      body { background-color: var(--bg-color); color: var(--text-main); transition: 0.3s; overflow-x: hidden; }
      .glass-panel { background: var(--panel-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--panel-border); box-shadow: 0 4px 30px rgba(0,0,0,0.1); }
      .theme-item { background: var(--item-bg); border: 1px solid var(--panel-border); }
      .theme-item:hover { background: var(--item-hover); }
      .theme-input { background: var(--input-bg); border: 1px solid var(--panel-border); color: var(--text-main); }
      .card-preserve-3d { transform-style: preserve-3d; }
      .card-backface-hidden { backface-visibility: hidden; }
      .rotate-y-180 { transform: rotateY(180deg); }
      ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-color); } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // --- ICONE INTEGRATE (Per evitare errori di caricamento esterno) ---
      const Icon = ({ path, size = 24, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
      );
      
      const Icons = {
        Trophy: (p) => <Icon {...p} path='<path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>' />,
        Users: (p) => <Icon {...p} path='<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>' />,
        Settings: (p) => <Icon {...p} path='<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>' />,
        Plus: (p) => <Icon {...p} path='<path d="M5 12h14"/><path d="M12 5v14"/>' />,
        X: (p) => <Icon {...p} path='<path d="M18 6 6 18"/><path d="m6 6 12 12"/>' />,
        Timer: (p) => <Icon {...p} path='<line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/>' />,
        VenetianMask: (p) => <Icon {...p} path='<path d="M2 12a5 5 0 0 0 5 5 8 8 0 0 1 5 2 8 8 0 0 1 5-2 5 5 0 0 0 5-5V7h-5a8 8 0 0 0-5 2 8 8 0 0 0-5-2H2Z"/><path d="M6 11c1.5 0 3 .5 3 2-2 0-3 0-3-2Z"/><path d="M18 11c-1.5 0-3 .5-3 2 2 0 3 0 3-2Z"/>' />,
        HelpCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/>' />,
        Eye: (p) => <Icon {...p} path='<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>' />,
        EyeOff: (p) => <Icon {...p} path='<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/>' />,
        User: (p) => <Icon {...p} path='<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>' />,
        Skull: (p) => <Icon {...p} path='<circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/>' />,
        Crown: (p) => <Icon {...p} path='<path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/>' />,
        AlertTriangle: (p) => <Icon {...p} path='<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/>' />,
        Home: (p) => <Icon {...p} path='<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>' />,
        Trash2: (p) => <Icon {...p} path='<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>' />,
        RotateCcw: (p) => <Icon {...p} path='<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>' />,
        Moon: (p) => <Icon {...p} path='<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>' />,
        Sun: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/>' />,
        Music: (p) => <Icon {...p} path='<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>' />,
        Volume2: (p) => <Icon {...p} path='<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>' />,
        VolumeX: (p) => <Icon {...p} path='<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/>' />,
        Lightbulb: (p) => <Icon {...p} path='<path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/>' />,
        Smartphone: (p) => <Icon {...p} path='<rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/>' />,
        Monitor: (p) => <Icon {...p} path='<rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/>' />
      };

      // --- COSTANTI ---
      const Role = { CIVILIAN: 'CIVILIAN', UNDERCOVER: 'UNDERCOVER', MR_WHITE: 'MR_WHITE' };
      const GamePhase = { SETUP: 'SETUP', PASS_PHONE: 'PASS_PHONE', GAMEPLAY: 'GAMEPLAY', GAME_OVER: 'GAME_OVER' };
      const STORAGE_KEY_PLAYERS = 'undercover_saved_players';
      const STORAGE_KEY_SETTINGS = 'undercover_saved_settings';
      const STORAGE_KEY_LEADERBOARD = 'undercover_neon_leaderboard';
      const STORAGE_KEY_USED_WORDS = 'undercover_used_words_v1';
      const STORAGE_KEY_THEME = 'undercover_theme_mode';
      const STORAGE_KEY_AUDIO = 'undercover_audio_settings';
      const STORAGE_KEY_MOBILE_MODE = 'undercover_mobile_mode';

      const WORDS_DB = [
        { civilian: "Pandoro", undercover: "Panettone", hint: "Dolce" },
        { civilian: "TiramisÃ¹", undercover: "Profiterole", hint: "Dolce" },
        { civilian: "Lasagna", undercover: "Cannelloni", hint: "Pasta" },
        { civilian: "Polpetta", undercover: "Polpettone", hint: "Carne" },
        { civilian: "Tonno", undercover: "Salmone", hint: "Pesce" },
        { civilian: "Miele", undercover: "Marmellata", hint: "Spalmabile" },
        { civilian: "Yogurt", undercover: "Budino", hint: "Cremoso" },
        { civilian: "Pistacchio", undercover: "Mandorla", hint: "Frutta secca" },
        { civilian: "Griglia", undercover: "Barbecue", hint: "Cottura" },
        { civilian: "Prosecco", undercover: "Spritz", hint: "Alcolico" },
        { civilian: "Mojito", undercover: "Gin Tonic", hint: "Cocktail" },
        { civilian: "Acqua Naturale", undercover: "Acqua Frizzante", hint: "Bevanda" },
        { civilian: "Rosmarino", undercover: "Salvia", hint: "Aroma" },
        { civilian: "Aglio", undercover: "Cipolla", hint: "Soffritto" },
        { civilian: "Fragola", undercover: "Lampone", hint: "Frutto" },
        { civilian: "Pera", undercover: "Mela", hint: "Frutto" },
        { civilian: "Parmigiano", undercover: "Pecorino", hint: "Formaggio" },
        { civilian: "Cozze", undercover: "Vongole", hint: "Mare" },
        { civilian: "Wurstel", undercover: "Salsiccia", hint: "Carne" },
        { civilian: "Patatine Fritte", undercover: "Chips", hint: "Snack" },
        { civilian: "Olio", undercover: "Aceto", hint: "Condimento" },
        { civilian: "Sale", undercover: "Pepe", hint: "Condimento" },
        { civilian: "Zucchero", undercover: "Dolcificante", hint: "Dolcezza" },
        { civilian: "Spaghetti", undercover: "Rigatoni", hint: "Pasta" },
        { civilian: "Tortellini", undercover: "Ravioli", hint: "Pasta" },
        { civilian: "Gambero", undercover: "Scampo", hint: "Crostaceo" },
        { civilian: "Limone", undercover: "Lime", hint: "Agrume" },
        { civilian: "Banana", undercover: "Platano", hint: "Frutto" },
        { civilian: "Pomodoro", undercover: "Peperone", hint: "Ortaggio" },
        { civilian: "Melanzana", undercover: "Peperone", hint: "Ortaggio" },
        { civilian: "Patata", undercover: "Carota", hint: "Ortaggio" },
        { civilian: "Basilico", undercover: "Prezzemolo", hint: "Erba" },
        { civilian: "Cioccolato Fondente", undercover: "Cioccolato al Latte", hint: "Cioccolato" },
        { civilian: "Pancetta", undercover: "Guanciale", hint: "Salume" },
        { civilian: "Crepes", undercover: "Pancake", hint: "Dolce" },
        { civilian: "Cuscino", undercover: "Guanciale", hint: "Letto" },
        { civilian: "Pettine", undercover: "Spazzola", hint: "Capelli" },
        { civilian: "Shampoo", undercover: "Bagnoschiuma", hint: "Bagno" },
        { civilian: "Valigia", undercover: "Zaino", hint: "Viaggio" },
        { civilian: "Ombrello", undercover: "Impermeabile", hint: "Pioggia" },
        { civilian: "Candela", undercover: "Lampadina", hint: "Luce" },
        { civilian: "Tappeto", undercover: "Zerbino", hint: "Pavimento" },
        { civilian: "Sedia", undercover: "Sgabello", hint: "Seduta" },
        { civilian: "Chiave", undercover: "Lucchetto", hint: "Sicurezza" },
        { civilian: "Dentifricio", undercover: "Collutorio", hint: "Denti" },
        { civilian: "Accendino", undercover: "Fiammifero", hint: "Fuoco" },
        { civilian: "Lavatrice", undercover: "Lavastoviglie", hint: "Elettrodomestico" },
        { civilian: "Scopa", undercover: "Aspirapolvere", hint: "Pulizia" },
        { civilian: "Forbici", undercover: "Tagliaunghie", hint: "Taglio" },
        { civilian: "Armadio", undercover: "Cassettiera", hint: "Mobile" },
        { civilian: "Coltello", undercover: "Taglierino", hint: "Utensile" },
        { civilian: "Piatto", undercover: "Ciotola", hint: "Cucina" },
        { civilian: "Padella", undercover: "Pentola", hint: "Cucina" },
        { civilian: "Forno", undercover: "Microonde", hint: "Cucina" },
        { civilian: "Frigorifero", undercover: "Freezer", hint: "Freddo" },
        { civilian: "Coperta", undercover: "Piumone", hint: "Letto" },
        { civilian: "Lenzuolo", undercover: "Tovaglia", hint: "Tessuto" },
        { civilian: "Tavolo", undercover: "Scrivania", hint: "Mobile" },
        { civilian: "Sapone", undercover: "Detersivo", hint: "Pulizia" },
        { civilian: "Profumo", undercover: "Deodorante", hint: "Odore" },
        { civilian: "Orologio", undercover: "Sveglia", hint: "Tempo" },
        { civilian: "Borsa", undercover: "Portafoglio", hint: "Accessorio" },
        { civilian: "Gomma", undercover: "Sbianchetto", hint: "Scrittura" },
        { civilian: "Quaderno", undercover: "Diario", hint: "Scrittura" },
        { civilian: "Giornale", undercover: "Fumetto", hint: "Lettura" },
        { civilian: "Busta", undercover: "Pacco", hint: "Spedizione" },
        { civilian: "Rana", undercover: "Rospo", hint: "Anfibio" },
        { civilian: "Cammello", undercover: "Dromedario", hint: "Deserto" },
        { civilian: "Polpo", undercover: "Calamaro", hint: "Mare" },
        { civilian: "Corvo", undercover: "Merlo", hint: "Uccello" },
        { civilian: "Vipera", undercover: "Biscia", hint: "Rettile" },
        { civilian: "Zanzara", undercover: "Mosca", hint: "Insetto" },
        { civilian: "Mucca", undercover: "Toro", hint: "Fattoria" },
        { civilian: "Panda", undercover: "Orso", hint: "Mammifero" },
        { civilian: "Cigno", undercover: "Oca", hint: "Uccello" },
        { civilian: "Gorilla", undercover: "Scimmia", hint: "Primate" },
        { civilian: "Criceto", undercover: "Cavia", hint: "Roditore" },
        { civilian: "Formica", undercover: "Termite", hint: "Insetto" },
        { civilian: "Gallo", undercover: "Gallina", hint: "Fattoria" },
        { civilian: "Squalo", undercover: "Orca", hint: "Mare" },
        { civilian: "Topo", undercover: "Ratto", hint: "Roditore" },
        { civilian: "Coniglio", undercover: "Lepre", hint: "Roditore" },
        { civilian: "Volpe", undercover: "Lupo", hint: "Selvatico" },
        { civilian: "Cervo", undercover: "Alce", hint: "Bosco" },
        { civilian: "Pappagallo", undercover: "Canarino", hint: "Uccello" },
        { civilian: "Ascensore", undercover: "Scale mobili", hint: "Trasporto" },
        { civilian: "Sauna", undercover: "Bagno Turco", hint: "Relax" },
        { civilian: "Stadio", undercover: "Arena", hint: "Sport" },
        { civilian: "Zoo", undercover: "Circo", hint: "Animali" },
        { civilian: "Cantina", undercover: "Soffitta", hint: "Stanza" },
        { civilian: "Balcone", undercover: "Terrazzo", hint: "Esterno" },
        { civilian: "Bar", undercover: "Pub", hint: "Locale" },
        { civilian: "Farmacia", undercover: "Ospedale", hint: "Salute" },
        { civilian: "Discoteca", undercover: "Concerto", hint: "Musica" },
        { civilian: "Campeggio", undercover: "Picnic", hint: "Aperto" },
        { civilian: "Grotta", undercover: "Caverna", hint: "Natura" },
        { civilian: "Isola", undercover: "Penisola", hint: "Terra" },
        { civilian: "Ponte", undercover: "Viadotto", hint: "Struttura" },
        { civilian: "Vulcano", undercover: "Cratere", hint: "Fuoco" },
        { civilian: "Cascata", undercover: "Fiume", hint: "Acqua" },
        { civilian: "Prato", undercover: "Giardino", hint: "Verde" },
        { civilian: "Aeroporto", undercover: "Stazione", hint: "Viaggio" },
        { civilian: "Chiesa", undercover: "Cattedrale", hint: "Religione" },
        { civilian: "Castello", undercover: "Fortezza", hint: "Edificio" },
        { civilian: "Barbiere", undercover: "Parrucchiere", hint: "Capelli" },
        { civilian: "Idraulico", undercover: "Elettricista", hint: "Tecnico" },
        { civilian: "Giudice", undercover: "Avvocato", hint: "Legge" },
        { civilian: "Pittore", undercover: "Scultore", hint: "Arte" },
        { civilian: "Cameriere", undercover: "Barista", hint: "Servizio" },
        { civilian: "Soldato", undercover: "Poliziotto", hint: "Divisa" },
        { civilian: "Attore", undercover: "Regista", hint: "Spettacolo" },
        { civilian: "Cantante", undercover: "Musicista", hint: "Musica" },
        { civilian: "Medico", undercover: "Infermiere", hint: "Salute" },
        { civilian: "Dentista", undercover: "Igienista", hint: "Denti" },
        { civilian: "Cuoco", undercover: "Pasticcere", hint: "Cucina" },
        { civilian: "Pilota", undercover: "Autista", hint: "Guida" },
        { civilian: "Maestro", undercover: "Professore", hint: "Scuola" },
        { civilian: "Architetto", undercover: "Ingegnere", hint: "Progetto" },
        { civilian: "Giornalista", undercover: "Scrittore", hint: "Scrittura" },
        { civilian: "Felpa", undercover: "Maglione", hint: "Busto" },
        { civilian: "Jeans", undercover: "Pantaloni", hint: "Gambe" },
        { civilian: "Cappotto", undercover: "Giacca", hint: "Inverno" },
        { civilian: "Guanti", undercover: "Muffole", hint: "Mani" },
        { civilian: "Calzini", undercover: "Calze", hint: "Piedi" },
        { civilian: "Cintura", undercover: "Bretelle", hint: "Accessorio" },
        { civilian: "Cappello", undercover: "Berretto", hint: "Testa" },
        { civilian: "Occhiali da sole", undercover: "Occhiali da vista", hint: "Occhi" },
        { civilian: "Bikini", undercover: "Costume intero", hint: "Mare" },
        { civilian: "Papillon", undercover: "Cravatta", hint: "Collo" },
        { civilian: "Gonna", undercover: "Vestito", hint: "Donna" },
        { civilian: "Super Mario", undercover: "Luigi", hint: "Videogioco" },
        { civilian: "Barbie", undercover: "Bratz", hint: "Bambola" },
        { civilian: "Topolino", undercover: "Paperino", hint: "Disney" },
        { civilian: "Shrek", undercover: "Fiona", hint: "Orco" },
        { civilian: "Yoda", undercover: "Darth Vader", hint: "Film" },
        { civilian: "Homer Simpson", undercover: "Peter Griffin", hint: "Cartone" },
        { civilian: "Messi", undercover: "Ronaldo", hint: "Calcio" },
        { civilian: "Ferrari", undercover: "Lamborghini", hint: "Auto" },
        { civilian: "Nike", undercover: "Adidas", hint: "Sport" },
        { civilian: "Pikachu", undercover: "Charizard", hint: "Anime" },
        { civilian: "Gandalf", undercover: "Silente", hint: "Mago" },
        { civilian: "Thor", undercover: "Loki", hint: "Supereroe" },
        { civilian: "Spongebob", undercover: "Patrick", hint: "Cartone" },
        { civilian: "Naruto", undercover: "Goku", hint: "Anime" },
        { civilian: "Bugia", undercover: "Segreto", hint: "VeritÃ " },
        { civilian: "Paura", undercover: "Ansia", hint: "Emozione" },
        { civilian: "Fortuna", undercover: "Destino", hint: "Caso" },
        { civilian: "Talento", undercover: "Genio", hint: "AbilitÃ " },
        { civilian: "Rumore", undercover: "Suono", hint: "Udito" },
        { civilian: "Caldo", undercover: "Afoso", hint: "Temperatura" },
        { civilian: "Veloce", undercover: "Rapido", hint: "VelocitÃ " },
        { civilian: "Ricco", undercover: "Benestante", hint: "Soldi" },
        { civilian: "Guerra", undercover: "Battaglia", hint: "Conflitto" },
        { civilian: "Passato", undercover: "Futuro", hint: "Tempo" },
        { civilian: "Vittoria", undercover: "Trionfo", hint: "Successo" },
        { civilian: "Errore", undercover: "Sbaglio", hint: "Sbaglio" }
      ];

      // --- LOGICA DI GIOCO ---
      const shuffleArray = (array) => {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      };

      const getLeaderboard = () => {
          try {
              const stored = localStorage.getItem(STORAGE_KEY_LEADERBOARD);
              if (!stored) return [];
              const data = JSON.parse(stored);
              return Object.values(data).sort((a, b) => b.wins - a.wins);
          } catch (e) { return []; }
      };

      const updateLeaderboard = (winners, allPlayers) => {
          const stored = localStorage.getItem(STORAGE_KEY_LEADERBOARD);
          let data = stored ? JSON.parse(stored) : {};
          allPlayers.forEach(player => {
              if (!data[player]) data[player] = { name: player, wins: 0, matches: 0 };
              data[player].matches += 1;
              if (winners.includes(player)) data[player].wins += 1;
          });
          localStorage.setItem(STORAGE_KEY_LEADERBOARD, JSON.stringify(data));
      };

      const getNewWordPair = () => {
        const storedUsed = localStorage.getItem(STORAGE_KEY_USED_WORDS);
        const usedIndices = storedUsed ? JSON.parse(storedUsed) : [];
        const availableIndices = WORDS_DB.map((_, index) => index).filter(index => !usedIndices.includes(index));
        if (availableIndices.length === 0) return null;
        const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
        usedIndices.push(randomIndex);
        localStorage.setItem(STORAGE_KEY_USED_WORDS, JSON.stringify(usedIndices));
        return WORDS_DB[randomIndex];
      };

      const resetUsedWordsHistory = () => localStorage.removeItem(STORAGE_KEY_USED_WORDS);

      // --- COMPONENTI UI ---
      const Button = ({ children, variant = 'primary', fullWidth = false, className = '', ...props }) => {
        const baseStyles = "px-6 py-4 rounded-xl font-display font-bold text-sm tracking-wider uppercase transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg";
        const variants = {
          primary: "bg-gradient-to-r from-neon-blue to-blue-600 text-white shadow-neon-blue/30 hover:shadow-neon-blue/50 border border-white/10",
          secondary: "theme-item text-theme-main hover:bg-white/20 border border-white/10 backdrop-blur-md",
          danger: "bg-gradient-to-r from-red-500 to-pink-600 text-white shadow-red-500/30 hover:shadow-red-500/50",
          ghost: "bg-transparent text-gray-400 hover:text-theme-main"
        };
        return <button className={`${baseStyles} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`} {...props}>{children}</button>;
      };

      const GuessResultOverlay = ({ result, onClose }) => {
        if (!result) return null;
        return (
          <div className={`fixed inset-0 z-[60] flex flex-col items-center justify-center p-6 animate-fadeIn ${result.isCorrect ? 'bg-green-600/95' : 'bg-red-600/95'} backdrop-blur-lg`}>
            <div className="text-center space-y-6 max-w-lg">
              <div className="flex justify-center mb-6">
                {result.isCorrect ? <Icons.Trophy size={80} className="text-yellow-300 drop-shadow-lg animate-bounce" /> : <Icons.X size={80} className="text-white drop-shadow-lg" />}
              </div>
              <h2 className="font-display text-5xl md:text-7xl font-black text-white drop-shadow-xl tracking-wider">{result.isCorrect ? "INDOVINATO!" : "SBAGLIATO!"}</h2>
              {!result.isCorrect && (
                <div className="bg-black/30 p-6 rounded-3xl border border-white/20 backdrop-blur-md">
                  <p className="text-white/80 uppercase text-sm font-bold tracking-widest mb-2">La parola era</p>
                  <p className="font-display text-3xl md:text-5xl font-bold text-white tracking-wide">{result.correctWord}</p>
                </div>
              )}
              <Button onClick={onClose} className="mt-10 bg-white text-black hover:bg-gray-100 shadow-xl border-none py-4 text-xl">CONTINUA</Button>
            </div>
          </div>
        );
      };

      const SettingsModal = ({ isOpen, onClose, isDarkMode, toggleTheme, audioSettings, setAudioSettings, settings, setSettings }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fadeIn">
            <div className="glass-panel w-full max-w-sm rounded-3xl p-6 relative shadow-2xl overflow-y-auto max-h-[90vh]">
              <button onClick={onClose} className="absolute top-4 right-4 text-theme-muted hover:text-theme-main transition-colors"><Icons.X size={24} /></button>
              <h2 className="text-xl font-display font-bold text-theme-main mb-6 flex items-center gap-2"><Icons.Settings size={24} className="text-neon-blue" />Impostazioni</h2>
              <div className="space-y-6">
                <div className="flex items-center justify-between p-4 theme-item rounded-2xl">
                  <div className="flex items-center gap-3">{isDarkMode ? <Icons.Moon size={24} className="text-neon-purple" /> : <Icons.Sun size={24} className="text-orange-400" />}<div><h3 className="font-bold text-theme-main">Tema</h3><p className="text-xs text-theme-muted">{isDarkMode ? 'ModalitÃ  Notte' : 'ModalitÃ  Giorno'}</p></div></div>
                  <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={!isDarkMode} onChange={toggleTheme} className="sr-only peer" /><div className="w-14 h-8 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-500"></div></label>
                </div>
                <div className="flex items-center justify-between p-4 theme-item rounded-2xl">
                  <div className="flex items-center gap-3"><Icons.Music size={24} className="text-neon-pink" /><div><h3 className="font-bold text-theme-main text-sm">Musica</h3></div></div>
                  <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={audioSettings.musicEnabled} onChange={() => setAudioSettings(prev => ({...prev, musicEnabled: !prev.musicEnabled}))} className="sr-only peer" /><div className="w-14 h-8 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-neon-pink"></div></label>
                </div>
                <div className="p-4 theme-item rounded-2xl space-y-3">
                  <div className="flex items-center justify-between"><div className="flex items-center gap-2">{audioSettings.volume > 0 ? <Icons.Volume2 size={20} className="text-neon-blue" /> : <Icons.VolumeX size={20} className="text-red-500" />}<span className="font-bold text-theme-main text-sm">Volume</span></div><span className="text-xs font-display font-bold text-neon-blue">{Math.round(audioSettings.volume * 100)}%</span></div>
                  <input type="range" min="0" max="1" step="0.01" value={audioSettings.volume} onChange={(e) => setAudioSettings(prev => ({...prev, volume: parseFloat(e.target.value)}))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-neon-blue" />
                </div>
                <div className="flex items-center justify-between p-4 theme-item rounded-2xl cursor-pointer hover:bg-neon-blue/10 transition-all group" onClick={() => window.open('https://docs.google.com/forms/d/e/1FAIpQLSd8d-9CGjw13tammArd4822xraNg8-d0gzfZ-mEAj7q2YW2XA/viewform?usp=dialog', '_blank')}>
                  <div className="flex items-center gap-3"><Icons.HelpCircle size={24} className="text-neon-blue group-hover:animate-bounce" /><div><h3 className="font-bold text-theme-main text-sm">Problemi o consigli?</h3><p className="text-xs text-theme-muted">Dacci un suggerimento su Google</p></div></div><Icons.Plus size={18} className="text-theme-muted group-hover:text-neon-blue" />
                </div>
              </div>
            </div>
          </div>
        );
      };

      const SetupScreen = ({ onStartGame, isDarkMode, settings, setSettings, isMobileMode }) => {
        const [players, setPlayers] = useState(() => { const saved = localStorage.getItem(STORAGE_KEY_PLAYERS); return saved ? JSON.parse(saved) : []; });
        const [inputValue, setInputValue] = useState('');
        const [activeTab, setActiveTab] = useState('setup');
        const [leaderboard, setLeaderboard] = useState([]);

        useEffect(() => { setLeaderboard(getLeaderboard()); }, [activeTab]);
        useEffect(() => { localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings)); }, [settings]);
        useEffect(() => { localStorage.setItem(STORAGE_KEY_PLAYERS, JSON.stringify(players)); }, [players]);

        const addPlayer = () => { if (inputValue.trim() && !players.includes(inputValue.trim())) { setPlayers([...players, inputValue.trim()]); setInputValue(''); } };
        const removePlayer = (index) => { setPlayers(players.filter((_, i) => i !== index)); };
        const handleClearPlayers = () => { if (players.length > 0 && window.confirm("Cancellare tutti i giocatori?")) setPlayers([]); };
        const handleClearLeaderboard = () => { if (window.confirm("Azzerare classifica?")) { localStorage.removeItem(STORAGE_KEY_LEADERBOARD); setLeaderboard([]); } };
        const handleStart = () => { const total = settings.undercoverCount + settings.mrWhiteCount; if (players.length >= 3 && total > 0 && total < players.length) onStartGame(players, settings); };
        const formatTime = (seconds) => { const m = Math.floor(seconds / 60); const s = seconds % 60; return `${m}:${s.toString().padStart(2, '0')}`; };
        const totalImpostors = settings.undercoverCount + settings.mrWhiteCount;
        const isValidConfig = players.length >= 3 && totalImpostors > 0 && totalImpostors < players.length;
        const containerPadding = isMobileMode ? "p-3" : "p-6 md:p-8";
        const settingsRowClass = isMobileMode ? "flex flex-col items-stretch gap-3 p-3 theme-item rounded-2xl transition-colors mb-2" : "flex items-center justify-between p-2 theme-item rounded-2xl transition-colors";
        const settingsControlsClass = isMobileMode ? "flex items-center justify-between gap-4 theme-input rounded-2xl p-2 w-full" : "flex items-center gap-4 theme-input rounded-2xl p-2";

        return (
          <div className="flex flex-col h-full w-full max-w-5xl mx-auto relative z-10 p-4 md:p-8 bg-transparent">
            <div className="text-center mb-6 pt-4"><h1 className={`font-display font-black text-transparent bg-clip-text bg-gradient-to-r from-neon-blue via-gray-200 to-neon-pink drop-shadow-[0_0_25px_rgba(0,243,255,0.4)] animate-pulse-slow break-all ${isMobileMode ? 'text-4xl' : 'text-4xl md:text-7xl'}`}>ğ•Œâ„•ğ”»ğ”¼â„â„‚ğ•†ğ•ğ”¼â„</h1><p className="text-theme-muted text-xs md:text-sm tracking-[0.6em] mt-2 uppercase font-bold">ğ‘ºğ‘·ğ‘¬ğ‘ªğ‘°ğ‘¨ğ‘³ ğ‘¬ğ‘«ğ‘°ğ‘»ğ‘°ğ‘¶ğ‘µ</p></div>
            <div className={`flex justify-center gap-6 mt-4 mb-6`}><img src="https://www.undercovergioco.it/logo.png" className={`${isMobileMode ? 'w-20 h-20' : 'w-28 h-28 md:w-32 md:h-32'} object-cover rounded-2xl border-2 border-neon-blue/30 shadow-lg shadow-neon-blue/20 rotate-[-5deg]`} /><img src="https://annarossoni.it/prod/wp-content/uploads/2025/02/sindrome-impostore-6.jpg" className={`${isMobileMode ? 'w-20 h-20' : 'w-28 h-28 md:w-32 md:h-32'} object-cover rounded-2xl border-2 border-neon-pink/30 shadow-lg shadow-neon-pink/20 rotate-[5deg]`} /></div>
            <div className="flex justify-center gap-6 mb-6"><div className="theme-item p-1.5 rounded-2xl inline-flex shadow-lg backdrop-blur-sm"><button onClick={() => setActiveTab('setup')} className={`px-6 py-2 text-sm md:text-base font-bold rounded-xl transition-all duration-300 ${activeTab === 'setup' ? 'bg-gradient-to-r from-neon-blue/20 to-blue-500/20 text-theme-main shadow-lg border border-neon-blue/30' : 'text-theme-muted hover:text-theme-main hover:bg-white/5'}`}>GIOCA</button><button onClick={() => setActiveTab('leaderboard')} className={`px-6 py-2 text-sm md:text-base font-bold rounded-xl transition-all duration-300 ${activeTab === 'leaderboard' ? 'bg-gradient-to-r from-neon-pink/20 to-purple-500/20 text-theme-main shadow-lg border border-neon-pink/30' : 'text-theme-muted hover:text-theme-main hover:bg-white/5'}`}>CLASSIFICA</button></div></div>
            {activeTab === 'setup' ? (
              <div className="flex-1 flex flex-col min-h-0 pb-28 md:pb-0">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                  <div className={`glass-panel ${containerPadding} rounded-[2rem] flex flex-col h-full shadow-2xl`}>
                    <div className="flex justify-between items-center mb-4"><h3 className="text-sm font-bold text-theme-muted uppercase flex items-center gap-2 tracking-wider"><Icons.Users size={18} className="text-neon-blue" /> Giocatori ({players.length})</h3>{players.length > 0 && (<button onClick={handleClearPlayers} className="text-theme-muted hover:text-red-500 hover:bg-red-500/10 p-2 rounded-lg transition-colors flex items-center gap-2 text-xs uppercase font-bold tracking-wider" title="Cancella tutti i giocatori"><Icons.Trash2 size={16} /> Reset</button>)}</div>
                    <div className="flex gap-2 mb-6"><input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addPlayer()} placeholder="Nome giocatore..." className="flex-1 theme-input rounded-2xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:border-neon-blue focus:ring-1 focus:ring-neon-blue transition-all text-base shadow-inner" /><button onClick={addPlayer} className="bg-gradient-to-r from-neon-blue to-blue-600 text-white rounded-2xl w-14 flex items-center justify-center shadow-lg shadow-neon-blue/20 hover:shadow-neon-blue/40 border border-white/10 transition-all active:scale-95 hover:scale-105 group" aria-label="Aggiungi"><Icons.Plus size={28} strokeWidth={3} className="group-hover:rotate-90 transition-transform duration-300" /></button></div>
                    <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar"><div className="flex flex-wrap gap-2 content-start">{players.map((p, i) => (<div key={i} className={`flex items-center gap-2 theme-item pl-4 pr-2 py-2 rounded-xl animate-fadeIn group hover:border-neon-blue/30 transition-all shadow-md ${isMobileMode ? 'text-sm' : 'text-base'}`}><span className="font-bold text-theme-main group-hover:text-neon-blue transition-colors">{p}</span><button onClick={() => removePlayer(i)} className="text-theme-muted hover:text-red-500 hover:bg-red-500/10 transition-colors rounded-lg p-1.5"><Icons.X size={16} /></button></div>))}{players.length === 0 && (<div className="w-full h-32 flex flex-col items-center justify-center text-theme-muted border-2 border-dashed border-gray-500/20 rounded-3xl bg-black/5"><Icons.Users size={32} className="mb-2 opacity-30 text-neon-blue" /><p className="text-sm font-medium">Nessun giocatore</p><p className="text-xs opacity-60">Aggiungi almeno 3 giocatori</p></div>)}</div></div>
                  </div>
                  <div className="space-y-4 flex flex-col">
                    <div className={`glass-panel ${containerPadding} rounded-[2rem] space-y-4 flex-1 shadow-2xl`}>
                      <h3 className="text-sm font-bold text-theme-muted uppercase mb-2 flex items-center gap-2 tracking-wider"><Icons.Settings size={18} className="text-neon-pink" /> Ruoli</h3>
                      <div className={`theme-item rounded-2xl transition-colors ${isMobileMode ? 'p-3' : 'p-2'}`}>
                        <div className={isMobileMode ? "flex flex-col gap-3 mb-2" : "flex items-center justify-between mb-2"}><div className="flex items-center gap-4"><div className={`p-3 rounded-2xl transition-all duration-300 ${settings.mrWhiteCount > 0 ? 'bg-white text-black shadow-[0_0_20px_rgba(255,255,255,0.3)] scale-110' : 'theme-item text-gray-500'}`}><Icons.HelpCircle size={24} /></div><div><h3 className={`font-bold text-lg transition-colors ${settings.mrWhiteCount > 0 ? 'text-theme-main' : 'text-theme-muted'}`}>Mister White</h3><p className="text-xs text-theme-muted mt-0.5">Non conosce la parola</p></div></div><div className={settingsControlsClass}><button className="w-10 h-10 flex items-center justify-center theme-item rounded-xl hover:bg-white/20 text-theme-main disabled:opacity-30 transition-colors" disabled={settings.mrWhiteCount === 0} onClick={() => setSettings(s => ({...s, mrWhiteCount: Math.max(0, s.mrWhiteCount - 1)}))}>-</button><span className="font-display font-bold w-8 text-center text-theme-main text-xl">{settings.mrWhiteCount}</span><button className="w-10 h-10 flex items-center justify-center theme-item rounded-xl hover:bg-white/20 text-theme-main transition-colors" onClick={() => setSettings(s => ({...s, mrWhiteCount: s.mrWhiteCount + 1}))}>+</button></div></div>
                        <div className="flex items-center justify-between px-2 pb-1 pt-2 border-t border-white/5"><span className="text-xs text-theme-muted flex items-center gap-2 font-bold uppercase tracking-wider"><Icons.Lightbulb size={16} className={settings.mrWhiteHintEnabled ? "text-yellow-400" : "text-gray-500"} /> Abilita indizio</span><label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={settings.mrWhiteHintEnabled} onChange={(e) => setSettings({...settings, mrWhiteHintEnabled: e.target.checked})} className="sr-only peer" /><div className="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-400"></div></label></div>
                      </div>
                      <div className={settingsRowClass}><div className="flex items-center gap-4"><div className={`p-3 rounded-2xl transition-all duration-300 ${settings.undercoverCount > 0 ? 'bg-neon-pink text-black shadow-[0_0_20px_rgba(255,0,255,0.3)] scale-110' : 'theme-item text-gray-500'}`}><Icons.VenetianMask size={24} /></div><div><h3 className={`font-bold text-lg transition-colors ${settings.undercoverCount > 0 ? 'text-theme-main' : 'text-theme-muted'}`}>Infiltrati</h3><p className="text-xs text-theme-muted mt-0.5">Hanno parola diversa</p></div></div><div className={settingsControlsClass}><button className="w-10 h-10 flex items-center justify-center theme-item rounded-xl hover:bg-white/20 text-theme-main disabled:opacity-30 transition-colors" disabled={settings.undercoverCount === 0} onClick={() => setSettings(s => ({...s, undercoverCount: Math.max(0, s.undercoverCount - 1)}))}>-</button><span className="font-display font-bold w-8 text-center text-neon-pink text-xl">{settings.undercoverCount}</span><button className="w-10 h-10 flex items-center justify-center theme-item rounded-xl hover:bg-white/20 text-theme-main transition-colors" onClick={() => setSettings(s => ({...s, undercoverCount: s.undercoverCount + 1}))}>+</button></div></div>
                    </div>
                    <div className={`glass-panel ${containerPadding} rounded-[2rem] space-y-4 flex-1 shadow-2xl`}>
                      <div className="flex items-center justify-between"><div className="flex items-center gap-4"><div className={`p-3 rounded-2xl transition-all duration-300 ${settings.timerEnabled ? 'bg-neon-green text-black shadow-[0_0_20px_rgba(10,255,0,0.3)]' : 'theme-item text-gray-500'}`}><Icons.Timer size={24} /></div><div><h3 className={`font-bold text-lg transition-colors ${settings.timerEnabled ? 'text-theme-main' : 'text-theme-muted'}`}>Timer</h3><p className="text-xs text-theme-muted mt-0.5">Tempo per discutere</p></div></div><label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={settings.timerEnabled} onChange={e => setSettings({...settings, timerEnabled: e.target.checked})} className="sr-only peer" /><div className="w-14 h-8 bg-gray-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-gray-400 after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-neon-green peer-checked:after:bg-white"></div></label></div>
                      {settings.timerEnabled && (<div className={`flex ${isMobileMode ? 'flex-col gap-3 items-stretch' : 'items-center justify-between'} pl-2 animate-fadeIn theme-item p-4 rounded-2xl`}><span className="text-sm font-bold text-gray-300">Durata timer</span><div className={settingsControlsClass}><button className="w-10 h-10 flex items-center justify-center theme-item rounded-lg hover:bg-white/20 text-theme-main transition-colors" onClick={() => setSettings(s => ({...s, timerDuration: Math.max(30, s.timerDuration - 30)}))}>-</button><span className="font-display font-bold w-20 text-center text-neon-green text-lg tracking-wider">{formatTime(settings.timerDuration)}</span><button className="w-10 h-10 flex items-center justify-center theme-item rounded-lg hover:bg-white/20 text-theme-main transition-colors" onClick={() => setSettings(s => ({...s, timerDuration: s.timerDuration + 30}))}>+</button></div></div>)}
                    </div>
                  </div>
                </div>
                {!isValidConfig && players.length >= 3 && (<div className="mt-6 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-center backdrop-blur-md"><p className="text-red-400 font-bold text-sm">âš ï¸ Configurazione non valida.{totalImpostors === 0 ? " Aggiungi almeno un nemico." : " Troppi nemici per il numero di giocatori."}</p></div>)}
              </div>
            ) : (
              <div className="flex-1 min-h-0 flex flex-col pb-24">
                <div className="glass-panel rounded-3xl overflow-hidden border-0 flex-1 overflow-y-auto">
                  <table className="w-full text-left">
                    <thead className="theme-item text-theme-muted text-xs uppercase tracking-widest sticky top-0 backdrop-blur-md z-10"><tr><th className={`p-4 md:p-8`}>Rank</th><th className={`p-4 md:p-8`}>Player</th><th className={`p-4 md:p-8 text-right`}>Vittorie</th>{!isMobileMode && <th className="p-4 md:p-8 text-right">Partite</th>}</tr></thead>
                    <tbody className="divide-y divide-white/5">{leaderboard.map((entry, idx) => (<tr key={entry.name} className="hover:bg-white/5 transition-colors group"><td className="p-4 md:p-8 font-display font-bold text-theme-muted group-hover:text-theme-main transition-colors text-base">{idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `#${idx + 1}`}</td><td className="p-4 md:p-8 font-bold text-base md:text-xl text-theme-main">{entry.name}</td><td className="p-4 md:p-8 text-right font-display text-neon-blue text-xl shadow-neon-blue drop-shadow-sm">{entry.wins}</td>{!isMobileMode && <td className="p-4 md:p-8 text-right font-display text-theme-muted text-lg">{entry.matches}</td>}</tr>))}{leaderboard.length === 0 && (<tr><td colSpan={isMobileMode ? 3 : 4} className="p-16 text-center text-theme-muted italic text-sm">Nessuna partita registrata</td></tr>)}</tbody>
                  </table>
                </div>
                {leaderboard.length > 0 && (<div className="mt-6 flex justify-center"><button onClick={handleClearLeaderboard} className="flex items-center gap-2 px-6 py-3 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded-xl text-red-400 hover:text-red-200 transition-all text-xs uppercase font-bold tracking-wider"><Icons.RotateCcw size={16} /> Azzera Classifica</button></div>)}
              </div>
            )}
            {activeTab === 'setup' && (<div className="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-dark-bg/90 via-dark-bg/80 to-transparent z-30 pointer-events-none flex justify-center"><div className="w-full max-w-2xl pointer-events-auto"><Button fullWidth onClick={handleStart} disabled={!isValidConfig} className="py-4 text-lg tracking-[0.2em] shadow-[0_0_40px_rgba(0,243,255,0.3)] hover:shadow-[0_0_60px_rgba(0,243,255,0.5)] border-t border-white/20">INIZIA LA PARTITA</Button></div></div>)}
          </div>
        );
      };

      const PassScreen = ({ player, onNext, settings }) => {
        const [isFlipped, setIsFlipped] = useState(false);
        const [isTransitioning, setIsTransitioning] = useState(false);
        const handleCardClick = () => { if (isTransitioning) return; if (!isFlipped) setIsFlipped(true); else { setIsFlipped(false); setIsTransitioning(true); setTimeout(() => { setIsTransitioning(false); onNext(); }, 700); } };
        const getRoleIcon = () => { switch (player.role) { case Role.MR_WHITE: return <Icons.HelpCircle size={80} className="text-white" />; case Role.UNDERCOVER: return <Icons.VenetianMask size={80} className="text-neon-pink" />; default: return <Icons.User size={80} className="text-neon-blue" />; } };
        const getRoleName = () => { switch (player.role) { case Role.MR_WHITE: return "Mister White"; case Role.UNDERCOVER: return "Infiltrato"; default: return "Cittadino"; } };
        return (
          <div className="h-full w-full flex flex-col items-center justify-center p-6 relative">
            <div className="text-center mb-10 animate-float"><h2 className="text-theme-muted uppercase tracking-[0.3em] text-sm md:text-base mb-3">Turno di</h2><h1 className="font-display text-5xl md:text-6xl font-black text-theme-main transition-opacity duration-300 drop-shadow-xl">{player.name}</h1></div>
            <div className="w-full max-w-[320px] md:max-w-[420px] aspect-[3/4] cursor-pointer group perspective-1000" onClick={handleCardClick}><div className={`relative w-full h-full duration-700 transition-all card-preserve-3d ${isFlipped ? 'rotate-y-180' : ''}`}><div className="absolute inset-0 w-full h-full card-backface-hidden"><div className="w-full h-full glass-panel rounded-[2.5rem] border-2 border-neon-blue/30 flex flex-col items-center justify-center p-10 shadow-[0_0_30px_rgba(0,243,255,0.1)] group-hover:shadow-[0_0_60px_rgba(0,243,255,0.3)] transition-shadow"><div className="w-32 h-32 rounded-full bg-neon-blue/10 flex items-center justify-center mb-8 animate-pulse-slow ring-1 ring-neon-blue/30"><Icons.Eye size={64} className="text-neon-blue" /></div><h3 className="font-display text-3xl font-bold text-center mb-4 tracking-wider text-theme-main">TOCCA PER<br/>RIVELARE</h3><p className="text-theme-muted text-center text-sm md:text-base max-w-[80%]">Assicurati che nessun altro stia guardando lo schermo</p></div></div><div className="absolute inset-0 w-full h-full card-backface-hidden rotate-y-180"><div className={`w-full h-full rounded-[2.5rem] border-2 flex flex-col items-center justify-center p-10 shadow-2xl backdrop-blur-xl ${player.role === Role.CIVILIAN ? 'border-neon-blue/50 shadow-neon-blue/20' : player.role === Role.UNDERCOVER ? 'border-neon-pink/50 shadow-neon-pink/20' : 'border-white/50 shadow-white/20'}`} style={{backgroundColor: 'var(--card-back)'}}><div className="mb-8 transform scale-110">{getRoleIcon()}</div><h3 className="font-display text-2xl font-bold mb-10 opacity-80 tracking-[0.2em] uppercase text-white">{getRoleName()}</h3><div className="w-full bg-black/40 rounded-2xl p-8 text-center border border-white/5 mb-10 shadow-inner"><p className="text-xs text-gray-400 uppercase mb-3 tracking-wider">La tua parola segreta</p><p className="font-display text-4xl md:text-5xl font-black tracking-wider break-words text-white drop-shadow-lg">{player.role === Role.MR_WHITE ? "???" : player.word}</p>{player.role === Role.MR_WHITE && settings.mrWhiteHintEnabled && player.hint && (<div className="mt-4 pt-4 border-t border-white/10"><p className="text-xs text-yellow-400 uppercase font-bold tracking-widest mb-1">Indizio</p><p className="text-lg text-white font-medium italic">"{player.hint}"</p></div>)}</div><div className="mt-auto flex flex-col items-center text-gray-400"><Icons.EyeOff size={28} className="mb-2" /><span className="text-xs uppercase tracking-[0.2em]">Tocca per nascondere</span></div></div></div></div></div>
          </div>
        );
      };

      const GameScreen = ({ players, onEliminate, gameStatus, setGameStatus, settings }) => {
        const [timeLeft, setTimeLeft] = useState(settings.timerDuration);
        const [selectedPlayer, setSelectedPlayer] = useState(null);
        useEffect(() => { let interval; if (settings.timerEnabled && gameStatus === 'playing' && timeLeft > 0) { interval = setInterval(() => { setTimeLeft((prev) => prev - 1); }, 1000); } return () => clearInterval(interval); }, [gameStatus, timeLeft, settings.timerEnabled]);
        const handlePlayerClick = (id) => { if (gameStatus === 'voting') { const p = players.find(pl => pl.id === id); if (p && p.isAlive) { setSelectedPlayer(id); } } };
        const confirmElimination = () => { if (selectedPlayer) { onEliminate(selectedPlayer); setSelectedPlayer(null); } };
        const formatTime = (seconds) => { const m = Math.floor(seconds / 60); const s = seconds % 60; return `${m}:${s.toString().padStart(2, '0')}`; };
        return (
          <div className="h-full w-full flex flex-col p-6">
            <div className="flex justify-between items-center mb-8 sticky top-0 z-20 bg-inherit/80 backdrop-blur-sm py-4">{settings.timerEnabled ? (<div className="px-6 py-3 bg-white/5 rounded-xl border border-white/10 backdrop-blur-md shadow-lg theme-item"><span className={`font-display font-bold text-3xl ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-theme-main'}`}>{gameStatus === 'playing' ? formatTime(timeLeft) : 'VOTAZIONE'}</span></div>) : (<div className="px-6 py-3 bg-white/5 rounded-xl border border-white/10 backdrop-blur-md shadow-lg theme-item"><span className="font-display font-bold text-lg text-neon-blue tracking-wider">{gameStatus === 'playing' ? 'IN CORSO' : 'VOTAZIONE'}</span></div>)}<div className="text-sm font-medium text-right text-theme-muted bg-black/10 px-4 py-2 rounded-lg theme-item"><p className="mb-1"><span className="text-green-400">â—</span> VIVI: {players.filter(p => p.isAlive).length}</p><p><span className="text-red-500">â—</span> ELIMINATI: {players.filter(p => !p.isAlive).length}</p></div></div>
            <div className="flex-1 overflow-y-auto pb-32"><div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6 lg:gap-8 content-start">{players.map((p) => (<div key={p.id} onClick={() => handlePlayerClick(p.id)} className={`relative aspect-square rounded-3xl p-4 flex flex-col items-center justify-center text-center transition-all duration-300 border-2 group ${!p.isAlive ? 'opacity-40 grayscale border-gray-500 bg-black/50' : ''} ${gameStatus === 'voting' && p.isAlive ? 'cursor-pointer hover:scale-[1.02] active:scale-95 animate-pulse-slow hover:shadow-neon-blue/20 hover:border-neon-blue/50' : ''} ${selectedPlayer === p.id ? 'border-red-500 bg-red-500/10 shadow-[0_0_30px_rgba(239,68,68,0.3)] scale-[0.98]' : 'border-transparent theme-item hover:border-white/20'}`}>{p.isStarter && (<div className="absolute top-3 right-3 text-yellow-400 drop-shadow-md" title="Primo giocatore"><Icons.Crown size={20} fill="currentColor" /></div>)}<div className={`w-16 h-16 md:w-20 md:h-20 rounded-full mb-4 flex items-center justify-center text-3xl md:text-4xl font-bold shadow-xl ring-4 ring-black/10 ${!p.isAlive ? 'bg-gray-800 text-gray-500' : 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white'}`}>{!p.isAlive ? <Icons.Skull size={28} /> : p.name.charAt(0).toUpperCase()}</div><h3 className={`font-display font-black leading-tight break-words w-full px-2 ${p.name.length > 8 ? 'text-lg md:text-xl' : 'text-2xl md:text-3xl'} ${p.isAlive ? 'text-transparent bg-clip-text bg-gradient-to-r from-theme-main to-gray-400 group-hover:from-neon-blue group-hover:to-white transition-all' : 'text-gray-500 line-through decoration-red-500 decoration-2'}`}>{p.name}</h3>{!p.isAlive && (<span className="text-xs md:text-sm text-red-500 font-bold uppercase tracking-widest mt-2 border border-red-500/30 px-2 py-0.5 rounded-full">ELIMINATO</span>)}{selectedPlayer === p.id && (<div className="absolute inset-0 rounded-3xl border-4 border-red-500 animate-pulse pointer-events-none"></div>)}</div>))}</div></div>
            <div className="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-dark-bg/50 via-dark-bg/20 to-transparent z-30"><div className="max-w-2xl mx-auto">{gameStatus === 'playing' ? (<Button fullWidth variant="danger" className="text-lg py-5 shadow-2xl" onClick={() => { setGameStatus('voting'); setTimeLeft(0); }}>AVVIA VOTAZIONE</Button>) : (<div className="space-y-4"><div className="bg-red-500/10 border border-red-500/20 rounded-xl p-4 flex items-center gap-4 justify-center backdrop-blur-md"><Icons.AlertTriangle className="text-red-500 flex-shrink-0 w-6 h-6" /><p className="text-base md:text-lg text-red-500 font-medium">{selectedPlayer ? <span>Vuoi eliminare <span className="font-bold underline decoration-red-500 text-theme-main">{players.find(p => p.id === selectedPlayer)?.name}</span>?</span> : "Seleziona un giocatore da eliminare"}</p></div><Button fullWidth variant="danger" className="text-lg py-5 shadow-2xl" disabled={!selectedPlayer} onClick={confirmElimination}>ELIMINA GIOCATORE</Button></div>)}</div></div>
          </div>
        );
      };

      const App = () => {
        const [phase, setPhase] = useState(GamePhase.SETUP);
        const [players, setPlayers] = useState([]);
        const [turnIndex, setTurnIndex] = useState(0);
        const [civilianWord, setCivilianWord] = useState('');
        const [gameStatus, setGameStatus] = useState('playing');
        const [winners, setWinners] = useState(null);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [guessResult, setGuessResult] = useState(null);
        
        const [isDarkMode, setIsDarkMode] = useState(() => { const saved = localStorage.getItem(STORAGE_KEY_THEME); return saved ? JSON.parse(saved) : true; });
        const [isMobileMode, setIsMobileMode] = useState(() => { const saved = localStorage.getItem(STORAGE_KEY_MOBILE_MODE); const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); return saved ? JSON.parse(saved) : isMobileUA; });
        const [currentSettings, setCurrentSettings] = useState(() => { const saved = localStorage.getItem(STORAGE_KEY_SETTINGS); return saved ? JSON.parse(saved) : { mrWhiteCount: 1, undercoverCount: 1, timerEnabled: true, timerDuration: 60, mrWhiteHintEnabled: false }; });

        useEffect(() => { localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(currentSettings)); }, [currentSettings]);
        useEffect(() => { localStorage.setItem(STORAGE_KEY_MOBILE_MODE, JSON.stringify(isMobileMode)); }, [isMobileMode]);

        const audioRef = useRef(null);
        const [audioSettings, setAudioSettings] = useState(() => { const saved = localStorage.getItem(STORAGE_KEY_AUDIO); return saved ? JSON.parse(saved) : { musicEnabled: true, volume: 0.3 }; });

        useEffect(() => { if (isDarkMode) { document.body.classList.remove('light-mode'); } else { document.body.classList.add('light-mode'); } localStorage.setItem(STORAGE_KEY_THEME, JSON.stringify(isDarkMode)); }, [isDarkMode]);
        useEffect(() => { localStorage.setItem(STORAGE_KEY_AUDIO, JSON.stringify(audioSettings)); if (audioRef.current) { audioRef.current.volume = audioSettings.volume; if (audioSettings.musicEnabled) { audioRef.current.play().catch(e => console.log("Audio waiting interaction")); } else { audioRef.current.pause(); } } }, [audioSettings]);

        const toggleTheme = () => setIsDarkMode(!isDarkMode);
        const toggleMobileMode = () => setIsMobileMode(!isMobileMode);

        const startGame = (names, settings) => {
          setCurrentSettings(settings);
          let pair = getNewWordPair();
          if (!pair) { if (window.confirm("Hai finito le parole! Resettare?")) { resetUsedWordsHistory(); pair = getNewWordPair(); } else return; }
          if (!pair) return;
          
          setCivilianWord(pair.civilian);
          let roles = [];
          for (let i = 0; i < settings.mrWhiteCount; i++) roles.push(Role.MR_WHITE);
          for (let i = 0; i < settings.undercoverCount; i++) roles.push(Role.UNDERCOVER);
          while (roles.length < names.length) roles.push(Role.CIVILIAN);
          roles = shuffleArray(roles);

          const newPlayers = names.map((name, i) => ({ id: `p-${i}-${Date.now()}`, name, role: roles[i], word: roles[i] === Role.CIVILIAN ? pair.civilian : (roles[i] === Role.UNDERCOVER ? pair.undercover : undefined), hint: pair.hint, isAlive: true, isStarter: false }));
          newPlayers[Math.floor(Math.random() * newPlayers.length)].isStarter = true;
          setPlayers(shuffleArray(newPlayers));
          setTurnIndex(0); setGameStatus('playing'); setPhase(GamePhase.PASS_PHONE);
        };

        const handleNextPlayer = () => { if (turnIndex < players.length - 1) setTurnIndex(turnIndex + 1); else setPhase(GamePhase.GAMEPLAY); };
        const handleEliminate = (playerId) => {
          const eliminatedPlayer = players.find(p => p.id === playerId);
          if (!eliminatedPlayer) return;
          const updatedPlayers = players.map(p => p.id === playerId ? { ...p, isAlive: false } : p);
          setPlayers(updatedPlayers);
          if (eliminatedPlayer.role === Role.MR_WHITE) {
            setTimeout(() => {
              const guess = prompt(`Mr. White (${eliminatedPlayer.name}) Ã¨ stato scoperto! Indovina la parola dei civili:`);
              const isCorrect = guess && guess.toLowerCase().trim() === civilianWord.toLowerCase().trim();
              setGuessResult({ isCorrect, correctWord: civilianWord, player: eliminatedPlayer, updatedPlayers });
            }, 100);
          } else {
            checkWinCondition(updatedPlayers);
          }
          setGameStatus('playing');
        };

        const closeGuessResult = () => { const result = guessResult; setGuessResult(null); if (result.isCorrect) handleGameOver('Mr. White', [result.player.name]); else checkWinCondition(result.updatedPlayers); };
        const checkWinCondition = (currentPlayers) => {
          const alive = currentPlayers.filter(p => p.isAlive);
          const impostors = alive.filter(p => p.role !== Role.CIVILIAN);
          const civilians = alive.filter(p => p.role === Role.CIVILIAN);
          if (impostors.length >= civilians.length) handleGameOver('Impostori', players.filter(p => p.role !== Role.CIVILIAN).map(p => p.name));
          else if (impostors.length === 0) handleGameOver('Cittadini', players.filter(p => p.role === Role.CIVILIAN).map(p => p.name));
        };

        const handleGameOver = (winningTeam, winnerNames) => {
          setPhase(GamePhase.GAME_OVER);
          const end = Date.now() + 3000;
          const frame = () => { window.confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#00f3ff', '#ff00ff', '#ffffff'] }); window.confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#00f3ff', '#ff00ff', '#ffffff'] }); if (Date.now() < end) requestAnimationFrame(frame); };
          frame();
          let icon = <Icons.Trophy size={80} className="text-yellow-400" />;
          if (winningTeam === 'Impostori' || winningTeam === 'Mr. White') icon = <div className="text-7xl">ğŸ‘º</div>;
          setWinners({ team: winningTeam, icon });
          updateLeaderboard(winnerNames, players.map(p => p.name));
        };

        return (
          <div className="w-full min-h-screen font-sans overflow-x-hidden flex flex-col items-center relative transition-colors duration-300">
            <div className="fixed top-[-20%] left-[-20%] w-[50vw] h-[50vw] bg-neon-blue/10 rounded-full blur-[120px] pointer-events-none animate-pulse-slow z-0"></div>
            <div className="fixed bottom-[-20%] right-[-20%] w-[50vw] h-[50vw] bg-neon-pink/10 rounded-full blur-[100px] pointer-events-none animate-pulse-slow z-0" style={{ animationDelay: '1.5s' }}></div>
            <audio ref={audioRef} loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>
            <div className="fixed top-4 right-4 z-40 flex gap-3">
              <button onClick={toggleMobileMode} className="p-3 rounded-full bg-white/5 hover:bg-white/10 text-theme-main border border-white/10 backdrop-blur-md shadow-lg transition-all hover:scale-105 active:scale-95" title={isMobileMode ? "Passa a ModalitÃ  PC" : "Passa a ModalitÃ  Mobile"}>{isMobileMode ? <Icons.Smartphone size={24} className="text-neon-pink" /> : <Icons.Monitor size={24} className="text-neon-blue" />}</button>
              <button onClick={() => setIsSettingsOpen(true)} className="p-3 rounded-full bg-white/5 hover:bg-white/10 text-theme-main border border-white/10 backdrop-blur-md shadow-lg transition-all hover:scale-105 active:scale-95"><Icons.Settings size={24} /></button>
            </div>
            <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} isDarkMode={isDarkMode} toggleTheme={toggleTheme} audioSettings={audioSettings} setAudioSettings={setAudioSettings} settings={currentSettings} setSettings={setCurrentSettings} />
            <GuessResultOverlay result={guessResult} onClose={closeGuessResult} />
            <div className="relative z-10 w-full h-full flex-1 flex flex-col max-w-7xl mx-auto">
              {phase === GamePhase.SETUP && <SetupScreen onStartGame={startGame} isDarkMode={isDarkMode} settings={currentSettings} setSettings={setCurrentSettings} isMobileMode={isMobileMode} />}
              {phase === GamePhase.PASS_PHONE && <PassScreen player={players[turnIndex]} onNext={handleNextPlayer} settings={currentSettings} />}
              {phase === GamePhase.GAMEPLAY && <GameScreen players={players} onEliminate={handleEliminate} gameStatus={gameStatus} setGameStatus={setGameStatus} settings={currentSettings} />}
              {phase === GamePhase.GAME_OVER && winners && (
                <div className="flex-1 flex flex-col items-center justify-center p-8 text-center animate-fadeIn max-w-lg mx-auto">
                  <div className="mb-8 animate-bounce drop-shadow-[0_0_15px_rgba(255,215,0,0.5)]">{winners.icon}</div>
                  <h2 className="text-theme-muted uppercase tracking-[0.3em] text-lg mb-4">Vittoria</h2>
                  <h1 className="font-display text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-neon-blue to-neon-pink mb-12 drop-shadow-2xl">{winners.team}</h1>
                  <div className="glass-panel p-8 rounded-3xl w-full mb-12 transform hover:scale-105 transition-transform duration-300"><h3 className="text-sm text-theme-muted mb-4 uppercase tracking-wider">Parola Segreta</h3><p className="text-4xl font-bold text-theme-main tracking-wide">{civilianWord}</p></div>
                  <div className="space-y-4 w-full"><Button fullWidth onClick={() => setPhase(GamePhase.SETUP)}><Icons.Home className="inline-block mr-2" size={24} /> Torna al Menu</Button></div>
                </div>
              )}
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>